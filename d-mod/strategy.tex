\chapter{Base change for non-proper maps}
\label{ch:d-mod:strategy}

Let $\stack X$ be any stack, where we recall that all stacks are assumed to be QCA.
We are interested in computing the Hochschild cohomology
\[
    \HCoh\bigl(\catDMod{\stack X}\bigr).
\]
Let $Δ\colon \stack X → \stack X × \stack X$ is the diagonal map, which by assumption is schematic.
The dualizing module $ω_{\stack X}$ is always holonomic.
Thus we have $\dualize Δ_* ω_{\stack X} = Δ_! k_{\stack X}$.
With this we observe that
\begin{align*}
    \HCoh\bigl(\catDMod{\stack X}\bigr)
    & = \Hom_{\catDMod{\stack X × \stack X}}(Δ_* ω_{\stack X},\, Δ_* ω_{\stack X}) & &\text{(Lemma~\ref{lem:d-mod:pre:hcoh})} \\
    & = \opalg{\Hom_{\catDMod{\stack X × \stack X}}(Δ_! k_{\stack X},\, Δ_! k_{\stack X})} & & \text{(duality)} \\
    & = \opalg{\Hom_{\catDMod{\stack X × \stack X}}(k_{\stack X},\, Δ^! Δ_! k_{\stack X})} & & \text{(adjunction)} \\
    & = \opalg{\ΓdR\bigl(Δ^! Δ_! k_{\stack X}\bigr)},
\end{align*}
where the algebra structure on $\ΓdR\bigl(Δ^! Δ_! k_{\stack X}\bigr) = \Hom_{\catDMod{\stack X × \stack X}}(k_{\stack X},\, Δ^! Δ_! k_{\stack X})$ is the one induced by the $(Δ_!,Δ^!)$-adjunction monad.
Consider the Cartesian square
\[
    \begin{tikzcd}
        \ls{\stack X} \arrow[r, "p₁"] \arrow[d, "p₂"] & \stack X \arrow[d, "Δ"] \\
        \stack X \arrow[r, "Δ"] & \stack X × \stack X
    \end{tikzcd}
\]
Let us assume for the moment that $Δ$ (and hence $p_i$) was proper.
Then $Δ_* = Δ_!$ and $p_{2,*} = p_{2,!}$ and by Section~\ref{sec:d-mod:pre:monads} we have an isomorphism of monads
\begin{equation}
    \label{eq:d-mod:central_iso}
    p_{2,!} p₁^! → Δ^!Δ_!,
\end{equation}
which induces an isomorphism of algebras
\[
    \ΓdR\bigl(p_{2,!} p₁^! k_{\stack X}\bigr)
    →
    \ΓdR\bigl(Δ^! Δ_! k_{\stack X}\bigr).
\]
Of course, if $X$ is not an algebraic space, then $Δ$ is not proper (nor is it in general smooth).
Thus in general \eqref{eq:d-mod:central_iso} is not an isomorphism and there is no canonical structure of monad on $p_{2,!} p₁^!$.
We would like to apply Lemma~\ref{lem:d-mod:pre:groupoid_monad_hol} to construct a monad in special cases.
Thus the goal of this chapter is to give a criterion for the assumptions of Lemma~\ref{lem:d-mod:pre:groupoid_monad_hol}, i.e.~for base change to hold.

\section{A lemma on base change}\label{sec:d-mod:strategy:base-change}

Consider a Cartesian diagram of stacks
\[
    \begin{tikzcd}
        \stack Z \arrow[d, "p"] \arrow[r, "q"] & \stack X₁ \arrow[d, "f"] \\
        \stack X₂ \arrow[r, "g"] & \stack Y
    \end{tikzcd}
\]
with $f$ and $g$ schematic.
We have a morphism of functors $\catDModHol{\stack X₁} → \catDModHol{\stack X₂}$,
\begin{equation}
    \label{eq:d-mod:base-change-morphism}
     p_! q^! → g^! f_!
\end{equation}
induced by adjunctions
\begin{equation}
    \label{eq:d-mod:base-change-adjunctions}
    p_! q^! →
    p_! q^! f^! f_! =
    p_! p^! g^! f_! →
    g^! f_!.
\end{equation}
If $f$ is proper, then \eqref{eq:d-mod:base-change-morphism} is an isomorphism by Proposition~\ref{prop:d-mod:pre:base-change}.
To understand the behavior for non-proper $f$, we will approximate it by a proper morphism.

\begin{Def}
    A \emph{relative compactification} of a morphism $f\colon \stack X → \stack Y$ is a commutative diagram
    \[
        \begin{tikzcd}
            \stack X \arrow[r, hook, "j"] \arrow[dr, "f"'] & \bar{\stack X} \arrow[d, "\bar f"] \\
            & \stack Y
        \end{tikzcd}
    \]
    where $j$ is an open embedding and $\bar f$ is proper.
\end{Def}

\begin{Ex}
    A famous example of such a relative compactification is Drinfeld's compactification of the morphism $\Bun_B → \Bun_G$, where $\Bun_G$ is the stack of $G$-bundles on a curve $C$ with $G$ reductive and $B$ is a Borel subgroup of $G$ \cite{BravermanGaitsgory:2002:GeometricEisensteinSeries}\todo{References to original work by Drinfeld?}.
\end{Ex}

Let us assume that in the above situation there exists a relative compactification of $f\colon \stack X₁ → \stack Y$.
Let $\stack X₁^c$ be the closed complement of the open inclusion $j\colon \stack X₁ \hookrightarrow \bar{\stack X}₁$.
Similarly, we let $\bar{\stack Z} = \stack X₂ ×_{\stack Y} \bar{\stack X}₁$ and $\stack Z^c = \stack X₂ ×_{\stack Y} \stack X₁^c$.
The notation for the corresponding inclusion and projection maps is summarized in the following Cartesian diagrams.
\[
    \begin{tikzcd}
        \bar{\stack Z} \arrow[d, "\bar p"] \arrow[r, "\bar q"] & \bar{\stack X}₁ \arrow[d, "\bar f"] \\
        \stack X₂ \arrow[r, "g"] & \stack Y
    \end{tikzcd}
    \qquad\qquad
    \begin{tikzcd}
        \stack Z^c \arrow[r, hook, "i"] \arrow[d] & \bar{\stack Z} \arrow[d, "\bar q"] \\
        \stack X₁^c \arrow[r, hook] & \bar{\stack X}₁
    \end{tikzcd}
\]
We note that $\bar{\stack Z}$ is the disjoint union of the closed substack $\stack Z^c$ and the open substack $\stack Z$.

\begin{Lem}
    \label{lem:d-mod:base-change-criterion}%
    The cone of the morphism~\eqref{eq:d-mod:base-change-morphism} is
    \[
        \bar p_! i_*i^* \bar{q}^! j_!.
    \]
    In particular, if $i^* \bar{q}^! j_! = 0$, then~\eqref{eq:d-mod:base-change-morphism} is an isomorphism of functors.
\end{Lem}

\begin{proof}
    Let $\tilde\jmath\colon \stack Z \hookrightarrow \bar{\stack Z}$ be the open inclusion complement to $i$.
    We split the adjunction is \eqref{eq:d-mod:base-change-adjunctions} in two by using the compositions
    \[
        f = \bar f ∘ j
        ,\
        p = \bar p ∘ \tilde\jmath
        \text{ and }
        q = \bar q ∘ \tilde\jmath.
    \]
    Thus the adjunction $p_!q^!→ p_!q^!f^!f_!$ becomes the sequence
    \[
        p_!q^! →
        p_!q^! j^! j_! →
        p_!q^! j^! \bar f^! \bar f_! j_!.
    \]
    The equality $p_! q^! f^! f_! = p_! p^! g^! f_!$ then becomes
    \[
        p_! q^! j^! \bar f^! \bar f_! j_! =
        p_! \tilde\jmath^! \bar q^! \bar f^! \bar f_! j_! =
        p_! \tilde\jmath^! \bar p^! g^! \bar f_! j_!.
    \]
    Finally the adjunction $p_! p^! g^! f_! → g^! f_!$ becomes
    \[
        p_! \tilde\jmath^! \bar p^! g^! \bar f_! j_! =
        \bar p_! \tilde\jmath_! \tilde\jmath^! \bar p^! g^! \bar f_! j_! →
        \bar p_! \bar p^! g^! \bar f_! j_! →
        g^! \bar f_! j_! =
        g^! f_!.
    \]
    Let us apply the same adjunction morphisms in a different order.
    First the inclusions
    \[
        p_!q^!
        \xrightarrow{α}
        p_!q^! j^! j_!
        =
        \bar p_! \tilde\jmath_! \tilde\jmath^! \bar q^! j_!
        \xrightarrow{β}
        \bar p_! \bar q^! j_!,
    \]
    and then the actual base change
    \begin{equation}
        \label{eq:lem:d-mod:base-change-criterion:pf:split_morphism_base_change}
        \bar p_! \bar q^! j_!
        →
        \bar p_! \bar q^! \bar f^! \bar f_! j_!
        =
        \bar p_! \bar p^! g^! \bar f_! j_!
        →
        g^! \bar f_! j_!
        =
        g^! f_!.
    \end{equation}
    We note that the adjunction $α\colon \id → j^!j_!$ is an isomorphism and the composition of the maps in \eqref{eq:lem:d-mod:base-change-criterion:pf:split_morphism_base_change} is exactly the isomorphism of proper base change (cf.~Proposition~\ref{prop:d-mod:pre:base-change}).
    Thus the cone of the whole composition composition is the same as the cone of the morphism $β$, which is given by the recollement triangle
    \[
        \bar p_! \tilde\jmath_! \tilde\jmath^! \bar q^! j_!
        \xrightarrow{β}
        \bar p_! \bar q^! j_!
        \xrightarrow{\phantom{β}}
        \bar p_! i_* i^* \bar q^! j_!
        \xrightarrow{+1}.
        \qedhere
    \]
\end{proof}

\section{Relative compactification for quotient stacks}
\label{sec:d-mod:strategy:compactification}%

In the preceding section we simply assumed that a relative compactification of the diagonal exists.
We will now construct such a compactification for quotient stacks.
Thus $X$ be a scheme of finite type over $k$ and let $G$ be an affine algebraic group over $k$ acting on $X$.
Let $\stack X = X/G$ be the corresponding quotient stack.

Constructing a relative compactification of $Δ\colon \stack X → \stack X × \stack X$ is the same as a first constructing a $G × G$-equivariant relative compactification of $(\proj2, a)\colon G × X → X × X$ (where $a\colon G × X → X$ is the action map) and then taking the quotient by the $G × G$ action\footnote{%
    Here $G × G$ acts on $G × X$ by $(s₁,s₂) \cdot (g,x) = (s₂gs₁^{-1},\, s₁x)$.
}.
We let
\[
    Γ = \bigl\{(g, x, x, gx) ∈ G × X × X × X\bigr\}
\]
be the graph of $(\proj2, a)$.

We pick a $G$-equivariant compactification $\bar G$ of $G$ and let $\bar Γ$ be the closure of $Γ$ in $\bar G × X × X × X$.
We have an open embedding $j$ of $G × X \cong Γ$ into $\bar Γ$ and proper map $f\colon \bar Γ → X × X$ given by projection on the last two factors.
The composition $f ∘ j$ is equal to $(\proj2, a)$.

Instead of viewing $Γ$ as the graph of $(\proj2, a)$ we can drop the third factor and regard $Γ$ as the graph of the action map, i.e.
\[
    \Γsub{a} = \bigl\{(g, x, gx) ∈ G × X × X\bigr\}.
\]
The closure $\bar{ \Γsub{a}}$ of $\Γsub a$ in $\bar G × X × X$ identifies with $\bar Γ$.
Thus for ease of notation we will from now on always set $Γ = \Γsub a$ and $\bar Γ = \bar{\Γsub a}$.

\begin{Def}
    Let $\stack X = X/G$.
    With the above construction we set
    \[
        \bar{\stack X} = \rquot{\bar Γ}{G×G}.
    \]
    We have an open embedding $j\colon X \hookrightarrow \bar{\stack X}$ and a proper morphism $\bar Δ\colon \bar{\stack X} → \stack X × \stack X$ induced by the map $f$ above, such that $Δ = \bar Δ ∘ j$.
\end{Def}

\begin{Rem}
    In the case of $G = \Gm$ the compactification $\bar Γ$ is explicitly described in \cite{DrinfeldGaitsgory:2014:OnATheoremOfBraden}.
    In particular, if $X$ is smooth it is shown there that $\bar Γ$ is smooth over $\ps1$.
    It is possible to extend the methods of \cite{DrinfeldGaitsgory:2014:OnATheoremOfBraden} to quotients by higher dimensional tori.
    The resulting constructions are highly useful for doing explicit computations.
\end{Rem}

It is useful to consider only partial compactifications.
For this let $V$ be a $G$-stable subvariety of $\bar G$ and let $\bar{\Γsub V}$ be the closure of $Γ$ in $G × V$.
We set
\[
    \bar{\stack X}_V = \rquot{\bar{\Γsub V}}{G×G}.
\]
Clearly, if $\left\{V_i\right\}$ is an open cover of $\bar G$ by $G$-stable subvarieties, then $\left\{\bar{\stack X}_{V_i}\right\}$ is an open cover of $\bar{\stack X}$.

\section{\Goodstack\ stacks}

Let $\stack X = X/G$ be a quotient stack as before.
For any morphism of stacks $h\colon \stack Y → \stack X$ we set $\lsY{\stack X} = \stack X ×_{\stack X × \stack X} \stack Y$.
Thus we have the Cartesian diagram
\[
    \begin{tikzcd}
        \lsY \stack X \arrow[r, "q_{\stack Y}"] \arrow[d] & \stack X \arrow[d, "Δ"] \\
        \stack Y \arrow[r, "Δ∘h"] & \stack X × \stack X
    \end{tikzcd}
\]
Let us fix a relative compactification $\bar Δ \colon \bar{\stack X} → \stack X × \stack X$ as in Section~\ref{sec:d-mod:strategy:compactification}.
Using the notation of Section~\ref{sec:d-mod:strategy:base-change} we set $\clsY{\stack X} = \bar{\stack X} ×_{\stack X × \stack X} \stack Y$ and $\lscY{\stack X} = {\stack X}^c ×_{\stack X × \stack X} \stack Y$.
We let $\bar q_{\stack Y}\colon \clsY\stack X → \bar{\stack X}$ be the projection morphism and $i_{\stack Y}\colon \lscY\stack X \hookrightarrow \clsY\stack X$ the inclusion.

\begin{Def}
    A quotient stack $\stack X = X/G$ is called \emph{\goodstack} if for every quotient stack $\stack Y = Y/G$ and schematic morphism $\stack Y → \stack X$ the functor $i_{\stack Y}^* \bar q_{\stack Y}^! j_!$ vanishes on $\catDModHol{\stack X}$.
\end{Def}

We will show in Chapter~\ref{ch:d-mod:torus} that any stack of the form $\rquot{X}{\Gm^n}$ is \goodstack.
The reason for this definition is the following theorem which lets us compute the Hochschild cohomology of $\catDMod{\stack X}$ for \goodstack\ quotient stacks.

\begin{Thm}\label{thm:d-mod:good-is-good}
    If $\stack X = X/G$ is \goodstack, then there exists a canonical structure of monad on $p_{2,!}p₁^!$ and the morphism $p_{2,!}p₁^! → Δ^!Δ_!$ is an isomorphism of monads.
    In particular there is an isomorphism of algebras
    \[
        \HCoh\bigl(\catDMod{\stack X}\bigr)
        \cong
        \opalg{\ΓdR\bigl(p_{2,!} p₁^! k_{\stack X}\bigr)}.
    \]
\end{Thm}

In other words, Theorem~\ref{thm:d-mod:main} holds for \goodstack\ stacks.

\begin{proof}
    We apply Lemma~\ref{lem:d-mod:pre:groupoid_monad_hol} to the groupoid $\ls\stack X \rightrightarrows \stack X$.
    Thus we let $\stack G_\cx$ be the simplicial stack with
    \[
        \stack G_i = \underbrace{\ls\stack X ×_{\stack X} \dotsb ×_{\stack X} \ls\stack X}_{\text{$i$ factors}}.
    \]
    Any morphism $F\colon [n] → [m]$ in $\cat{Δ}^{\mathrm{op}}$ induces a diagram
    \[
        \begin{tikzcd}
            \stack G_{n+1} \arrow[d] \arrow[r] & \stack G_{m+1} \arrow[d] \arrow[r] & \stack X \arrow[d, "Δ"] \\
            \stack G_{n} \arrow[r] & \stack G_m \arrow[r] & \stack X × \stack X
        \end{tikzcd}
    \]
    We have to show that base change holds along the right-hand square.
    But by the assumption and Lemma~\ref{lem:d-mod:base-change-criterion}, base change holds along the outer rectangle and the left-hand square.
    Thus it also holds along the right-hand square.
\end{proof}

\begin{Ex}
    For any algebraic group $G$ the stack $\B G = \pt/G$ is \goodstack\todo{Add proof.}.
\end{Ex}

\begin{Ex}
    The stack $\ps1/\as1$ is not \goodstack.
    In fact a direct computation shows that Theorem~\ref{thm:d-mod:main} does not hold for this stack.
    We expect that most quotient stacks are not \goodstack.
    For non-\goodstack\ stacks, Lemma~\ref{lem:d-mod:base-change-criterion} instead gives a description of how much the naive expectation for $\HCoh\bigl(\catDMod{\stack X}\bigr)$ fails.
\end{Ex}

We finish this section with some useful observations for proving that a stack is \goodstack.

\begin{Lem}
    If $\stack X₁ = X₁/G₁$ and $\stack X₂ = X₂/G₂$ are \goodstack, then $\stack X₁ × \stack X₂$ is \goodstack.
\end{Lem}

\begin{proof}
    Follows from compatibility of $i_{\stack Y}^*\bar{q}_{\stack Y}^!j_!$ with $\boxtimes$ and coproducts.
    (Note that $\lscY{(\stack X₁ × \stack X₂)} = \lscY \stack{X₁} × \clsY \stack{X₂} ∪ \clsY{\stack X₁} × \lscY{\stack X₂}$.)
\end{proof}

\begin{Lem}
    Let $U$ be a $G$-equivariant open subset of $X$.
    If $X/G$ is \goodstack\ then $U/G$ is \goodstack.
\end{Lem}

\begin{proof}
    Let $\stack U = U/G$ and let $\stack Y$ be a quotient stack mapping into $\stack U$ (and hence also into $\stack X$).
    Consider the diagram
    \[
        \begin{tikzcd}
            \lscY \stack U \arrow[r, hook, "i_{\stack U, \stack Y}"] \arrow[d, hook, "α"] & \clsY{\stack U} \arrow[r, "\bar q_{\stack U,\stack Y}"] \arrow[d, hook, "β"] & \bar{\stack U} \arrow[d, hook, "γ"] & \stack U \arrow[l, hook', "j_{\stack U}"'] \arrow[d, hook, "δ"] \\
            \lscY \stack X \arrow[r, hook, "i_{\stack X, \stack Y}"]                      & \clsY{\stack X} \arrow[r, "\bar q_{\stack X,\stack Y}"]                      & \bar{\stack X}                      & \stack X \arrow[l, hook', "j_{\stack X}"']
        \end{tikzcd}
    \]
    The vertical arrows are open embeddings and all squares are Cartesian (where we use the same compactification of $G$ for $\bar{\stack X}$ and $\bar{\stack U}$).
    Thus
    \begin{equation}
        \label{eq:lem:d-mod:cover}
        i_{\stack U, \stack Y}^* \bar q_{\stack U,\stack Y}^! j_{\stack U,!} =
        i_{\stack U, \stack Y}^* \bar q_{\stack U,\stack Y}^! j_{\stack U,!} δ^* δ_*=
        α^* i_{\stack X, \stack Y}^* \bar q_{\stack X, \stack Y}^! j_{\stack X,!} δ_* =
        0.
        \qedhere
    \end{equation}
    \todo{Remove equation number, once next proof has been written.}
\end{proof}

\begin{Lem}
    \label{lem:d-mod:strategy:cover}%
    If there exists a $G$-stable open cover $U_i$ of $X$ such that all stacks $U_i/G$ are \goodstack, then $X/G$ is \goodstack.
\end{Lem}

\begin{proof}\todo{Write out proof}
    Show first that the stacks $\lscY{\stack U_i}$ form an open cover of $\lscY{\stack X}$.
    Then apply the same argument as~\eqref{eq:lem:d-mod:cover} backwards.
\end{proof}

The same argument can be used to reduce the computation to a smooth cover.
We will now introduce notation for the special case of the cover $\bar Γ → \bar{\stack X}$.
The corresponding covers of the other relevant stacks are introduced in the following diagram with Cartesian squares.
\begin{equation}
    \label{eq:d-mod:strategy:scheme-cover}
    \begin{tikzcd}
        \schemelscY \stack X \arrow[r, hook, "\schemei_{\stack Y}"] \arrow[d] & \schemeclsY \stack X \arrow[r, "\bar\schemeq_{\stack Y}"] \arrow[d] & \bar Γ \arrow[d] & Γ \arrow[l, hook', "\schemej"'] \arrow[d] \\
        \lscY \stack X \arrow[r, hook, "i_{\stack Y}"]                        & \clsY \stack X \arrow[r, "\bar q_{\stack Y}"]                       & \bar{\stack X}   & \stack X \arrow[l, hook', "j"']
    \end{tikzcd}
\end{equation}
We note that all vertical morphisms are smooth and the spaces in the top row are schemes.
Let $\schemeh\colon X → Y$ be the $G$-equivariant morphism of schemes inducing $h$ on quotient stacks.
Then the scheme $\schemeclsY \stack X$ is given by
\[
    \schemeclsY \stack X =
    \biggl\{
        \bigl(g₁,\, y,\, g₂\bigr) ∈ G × Y × \bar G : \bigl(\schemeh(y),\, g₂,\, g₁\schemeh(y)\bigr) ∈ \bar Γ
    \biggr\}.
\]

\begin{Lem}\label{lem:d-mod:strategy:scheme-cover}
    A stack $X/G$ is \goodstack\ if for each morphism $Y/G → X/G$ the composition $\schemei_{\stack Y}^* \bar\schemeq_{\stack Y}^! \schemej_!$ vanishes on $\catDModHolMon{Γ}{G×G}$.
\end{Lem}

\begin{proof}
    Follows from the fact that pullback along the smooth vertical morphisms in \eqref{eq:d-mod:strategy:scheme-cover} is conservative \cite[Lemma~5.1.6]{DrinfeldGaitsgory:2013:FinitenessQuestions} and permutes with the other morphisms up to a shift.
\end{proof}

Let $\left\{V_i\right\}$ be a $G$-stable open cover of $\bar G$ and consider the corresponding open cover $\left\{\bar{\stack X}_{V_i}\right\}$ of $\stack X$.
We obtain open covers $\left\{\cls_{V_i,\stack Y} \stack X\right\}$ and $\left\{\lsc_{V_i,\stack Y} \stack X\right\}$ of $\clsY{\stack X}$ and $\lscY{\stack X}$ respectively.
We let $i_{V_i,\stack X}$, $\bar q_{V_i,\stack X}$ and $j_{V_i}$ be the corresponding maps, i.e.
\[
    \begin{tikzcd}
        \cls_{V_i,\stack Y} \stack X \arrow[r, hook, "i_{V_i,\stack X}"] &
        \lsc_{V_i,\stack Y} \stack X \arrow[r, "\bar q_{V_i,\stack X}"] &
        \bar{\stack X}_{V_i} &
        \stack X \arrow[l, hook', "j_{V_i}"'].
    \end{tikzcd}
\]

\begin{Lem}\label{lem:d-mod:strategy:cover-by-relative-compactifications}
    With the above notation, the $\stack X$ is good if and only $i_{V_i,\stack Y}^* \bar q_{V_i,\stack Y}^! j_{V_i,!}$ vanishes on $\catDModHol{\stack X}$ for all $V_i$ and all $\stack Y → \stack X$.
\end{Lem}

\begin{proof}
    Similar to the proof of Lemmas~\ref{lem:d-mod:strategy:cover}.
\end{proof}
